---
// Preloader Component - Plane View Collective
---

<div id="preloader" class="preloader" style="display:none" transition:persist>
  <div id="preloader" class="preloader" style="display:none" transition:persist>
  <video
    class="preloader-animation"
    autoplay
    muted
    playsinline
    disablepictureinpicture
  >
    <!-- Mobile-optimized version first -->
    <source 
      src="/videos/mobile_website.webm" 
      type="video/webm"
      media="(max-width: 767px)" 
    />
    
    <!-- Desktop / larger screens -->
    <source 
      src="/videos/plane-intro.webm" 
      type="video/webm"
    />
    
    <!-- Optional fallback poster if video fails -->
    <!-- <img src="/images/preloader-fallback.jpg" alt="Plane View Intro" slot="poster"> but not needed here -->
  </video>

  <button id="preloader-skip" class="preloader-skip" type="button">
    Skip <span class="skip-arrow">→</span>
  </button>

  <div class="preloader-progress">
    <div class="preloader-bar" id="preloader-bar"></div>
  </div>
</div>

<script>
  const preloader = document.getElementById('preloader')!;
  const skipBtn   = document.getElementById('preloader-skip')!;
  const bar       = document.getElementById('preloader-bar')!;
  const video     = preloader.querySelector('video')!;

  function dismiss() {
    try { localStorage.setItem('pvc-intro-seen', '1'); } catch(e) {}

    preloader.classList.add('preloader-out');

    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';

    window.dispatchEvent(new Event('resize'));

    setTimeout(() => {
      preloader.style.display = 'none';
      // Free video from memory so it stops burning CPU/GPU after dismiss
      video.pause();
      video.src = '';
      video.load();
      window.dispatchEvent(new Event('resize'));
    }, 800);
  }

  let alreadySeen = false;
  try { alreadySeen = !!localStorage.getItem('pvc-intro-seen'); } catch(e) {}

  if (alreadySeen) {
    preloader.style.display = 'none';
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
  } else {
    preloader.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    // Slightly reduce playback rate on mobile to ease decoder load
    if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
      video.playbackRate = 0.95;
    }

    // Sync progress bar to actual video duration
    video.addEventListener('loadedmetadata', () => {
      bar.style.transition = `width ${video.duration / video.playbackRate}s linear`;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => { bar.style.width = '100%'; });
      });
    });

    const fallbackTimer = setTimeout(dismiss, 25000);

    video.addEventListener('ended', () => {
      clearTimeout(fallbackTimer);
      dismiss();
    });

    video.addEventListener('error', () => {
      clearTimeout(fallbackTimer);
      dismiss();
    });

    skipBtn.addEventListener('click', () => {
      clearTimeout(fallbackTimer);
      video.pause();
      dismiss();
    });
  }
</script>

<style>
  .preloader {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #111111;
    display: flex;
    align-items: center;
    justify-content: center;
    will-change: opacity;
    transition: opacity 0.8s ease;
  }

  .preloader-out {
    opacity: 0;
    pointer-events: none;
  }

  /* Desktop / landscape — cover fills screen cleanly */
  .preloader-animation {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center center;
    display: block;
    will-change: transform;
  }

  /* Wordmark */
  .preloader::before {
    content: 'PLANE VIEW';
    position: absolute;
    top: 36px;
    left: 40px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: rgba(255, 255, 255, 0.5);
    z-index: 2;
  }

  /* Skip button */
  .preloader-skip {
    position: absolute;
    bottom: 48px;
    right: 40px;
    z-index: 2;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: rgba(255, 255, 255, 0.85);
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    padding: 10px 20px;
    border-radius: 9999px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
  }

  .preloader-skip:hover {
    background: rgba(255, 255, 255, 0.22);
    border-color: rgba(255, 255, 255, 0.5);
    color: #fff;
  }

  .skip-arrow {
    transition: transform 0.2s ease;
  }

  .preloader-skip:hover .skip-arrow {
    transform: translateX(3px);
  }

  /* Progress bar */
  .preloader-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: rgba(255, 255, 255, 0.1);
    z-index: 2;
  }

  .preloader-bar {
    height: 100%;
    width: 0%;
    background: #2F6FED;
  }

  /* ── PORTRAIT CROP FIX ─────────────────────────────────────────────────────
     The video is 16:9 landscape. On a portrait phone:
     - inset:0 + 100% height resolves to the CSS viewport, not the real
       screen height — browser chrome causes gaps at top/bottom
     - This means object-fit:cover has the wrong reference dimensions
       and the crop doesn't fill the screen correctly

     Fix: explicitly set both container and video to 100dvh in portrait mode.
     dvh = dynamic viewport height — it accounts for browser chrome
     showing/hiding in real time, so the video always fills the true
     visible screen. object-fit:cover then scales the landscape video
     to fill portrait height and crops left/right — exactly what you want. */
  @media (orientation: portrait) {
    .preloader {
      height: 100dvh;
    }
    .preloader-animation {
      width: 100vw;
      height: 100dvh;
      object-fit: cover;
      object-position: center center;
    }
  }

  /* Mobile UI adjustments */
  @media (max-width: 768px) {
    .preloader::before {
      top: 28px;
      left: 24px;
      font-size: 0.7rem;
    }
    .preloader-skip {
      bottom: 40px;
      right: 24px;
      font-size: 0.8rem;
      padding: 8px 16px;
    }
  }

  @media (max-width: 480px) {
    .preloader::before {
      top: 20px;
      left: 16px;
      font-size: 0.65rem;
      letter-spacing: 0.15em;
    }
    .preloader-skip {
      bottom: 28px;
      right: 16px;
      font-size: 0.75rem;
      padding: 7px 14px;
      gap: 4px;
    }
  }

  /* Larger tap target on touch devices */
  @media (hover: none) and (pointer: coarse) {
    .preloader-skip {
      min-height: 44px;
      padding: 10px 20px;
    }
  }
  @media (max-width: 767px) {
    .preloader-animation {
      object-position: center 30%;   /* ← adjust if mobile video is composed differently */
    }
  }
</style>