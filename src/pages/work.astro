---
import MainLayout from '../layouts/MainLayout.astro';
import Navigation from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';

const projects = [
  {
    id: 1,
    client: "DAC's Transport Services",
    category: "Branding",
    year: "2024",
    description: "Logo design, brand identity, social media content, email campaigns, and a full website for a Cape Town-based transport company.",
    images: ["images/2.webp", "images/3.webp", "images/4.webp", "images/5.webp", ],
    gradient: "linear-gradient(135deg, #1a1f5e 0%, #6b70b8 100%)",
    accentColor: "#6b70b8",
    tags: ["Logo Design", "Social Media", "Web Design"],
  },
  {
    id: 3,
    client: "Tendr Buddi",
    category: "Branding",
    year: "2024",
    description: "Full brand identity system — wordmark, figure mark, combination mark, business cards, and poster design for a tender-matching platform.",
    images: ["images/10.webp", "images/11.webp", "images/12.webp", "images/13.webp", "images/14.webp", "images/15.webp", "images/16.webp", "images/17.webp", "images/18.webp", "images/19.webp", "images/20.webp", "images/21.webp","images/22.webp","images/23.webp","images/24.webp","images/25.webp","images/26.webp","images/27.webp","images/28.webp","images/29.webp"],
    gradient: "linear-gradient(135deg, #111111 0%, #3a2c00 100%)",
    accentColor: "#f5c400",
    tags: ["Brand Identity", "Print Design", "Guidelines"],
  },
  {
    id: 4,
    client: "WebNexo",
    category: "Web Design",
    year: "2024",
    description: "Logo, brand identity, colour system, typography guide, and full brand rollout across digital and physical touchpoints.",
    images: ["/images/34.webp", "/images/35.webp", "/images/36.webp", "/images/37.webp", "/images/38.webp", "/images/39.webp", "/images/40.webp"],
    gradient: "linear-gradient(135deg, #212121 0%, #005f6b 100%)",
    accentColor: "#00a5b5",
    tags: ["Web Design", "Brand Identity", "UI/UX"],
  },
];
---

<MainLayout
  title="Work | Plane View Collective"
  description="See how we help brands get noticed, understood, and remembered through strategic clarity and creative execution."
>
  <Navigation />

  <!-- Hero Section -->
  <section class="section page-hero">
    <div class="container container-narrow">
      <h1>Our Work</h1>
      <p class="intro-text">
        Every project is an opportunity to create clarity, build connection, and drive measurable results.
      </p>
    </div>
  </section>

  <!-- Filter -->
  <section class="section-sm">
    <div class="container">
      <div class="work-filter">
        <button class="filter-btn active" data-filter="all">All Work</button>
        <button class="filter-btn" data-filter="Branding">Branding</button>
        <button class="filter-btn" data-filter="Web Design">Web Design</button>
        <button class="filter-btn" data-filter="Marketing">Marketing</button>
      </div>
    </div>
  </section>

  <!-- Work Grid -->
  <section class="section" style="padding-bottom: 0;">
    <div class="container">
      <div class="work-grid">
        {projects.map((project) => (
          <article
            class="work-card"
            data-category={project.category}
            data-client={project.client}
            data-description={project.description}
            data-images={project.images ? JSON.stringify(project.images) : '[]'}
            data-gradient={project.gradient}
            data-tags={JSON.stringify(project.tags)}
            data-year={project.year}
          >
            <div class="work-image">
              {project.images && project.images.length > 0 ? (
                project.images.length > 1 ? (
                  <div class="work-gallery" data-gallery>
                    {project.images.map((src, i) => (
                      <img src={src} alt={`${project.client} — image ${i + 1}`} class={i === 0 ? 'active' : ''} />
                    ))}
                    <div class="gallery-dots">
                      {project.images.map((_, i) => (
                        <span class={`dot${i === 0 ? ' active' : ''}`} />
                      ))}
                    </div>
                  </div>
                ) : (
                  <img src={project.images[0]} alt={`${project.client} project`} />
                )
              ) : (
                <div class="work-placeholder" style={`background: ${project.gradient};`}>
                  <svg class="card-mark" width="56" height="56" viewBox="0 0 56 56" fill="none" aria-hidden="true">
                    <path d="M28 4 L52 52 L28 40 L4 52 Z" stroke="white" stroke-width="2" stroke-linejoin="round" fill="none" opacity="0.4"/>
                    <circle cx="28" cy="28" r="8" stroke="white" stroke-width="1.5" opacity="0.25"/>
                  </svg>
                </div>
              )}
            </div>

            <div class="work-content">
              <div class="work-meta">
                <span
                  class="work-category"
                  style={`color: ${['#e8d44d','#f5c400'].includes(project.accentColor) ? '#6B6B6B' : project.accentColor}`}
                >
                  {project.category}
                </span>
                <span class="work-year">{project.year}</span>
              </div>
              <h3>{project.client}</h3>
              <p>{project.description}</p>
              <div class="work-tags">
                {project.tags.map((tag) => (
                  <span class="work-tag">{tag}</span>
                ))}
              </div>
              <button class="work-link open-lightbox" type="button">
                View Our Work
                <span class="arrow">→</span>
              </button>
            </div>
          </article>
        ))}
      </div>
      <p class="no-results" id="no-results" aria-live="polite"></p>
    </div>
  </section>

  <!-- CTA -->
  <section class="section" style="padding-top: var(--spacing-lg);">
    <div class="container">
      <div class="cta-box">
        <h2>Want results like these?</h2>
        <p>Let's discuss how we can help your brand stand out.</p>
        <div class="cta-actions">
          <a href="/contact" class="btn btn-primary btn-lg">
            Start a Project
            <span class="arrow">→</span>
          </a>
          <a href="public/downloads/Plane View Collective Portfolio.pdf" download class="btn btn-outline btn-lg">
            Download Our Work
            <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 3V13M10 13L6 9M10 13L14 9M4 16H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Lightbox -->
  <!-- CHANGE: All lightbox CSS is now in global.css — styles here were scoped
       by Astro and never reached the JS-created <img> elements inside imgWrap -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Project viewer">
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-panel">
      <button class="lightbox-close" aria-label="Close">&times;</button>
      <div class="lightbox-body">
        <div class="lightbox-images">
          <div class="lightbox-img-wrap" id="lightbox-img-wrap"></div>
          <button class="lb-arrow lb-prev" id="lb-prev" aria-label="Previous image">&#8592;</button>
          <button class="lb-arrow lb-next" id="lb-next" aria-label="Next image">&#8594;</button>
          <div class="lightbox-counter" id="lightbox-counter"></div>
        </div>
        <div class="lightbox-info">
          <p class="lb-category" id="lb-category"></p>
          <h2 id="lb-client"></h2>
          <p id="lb-description"></p>
          <div class="lb-tags" id="lb-tags"></div>
          <span class="lb-year" id="lb-year"></span>
        </div>
      </div>
    </div>
  </div>

  <Footer />
</MainLayout>

<script>
  // ─── Filter Logic ────────────────────────────────────────────────────────────
  const filterBtns = document.querySelectorAll<HTMLButtonElement>('.filter-btn');
  const cards      = document.querySelectorAll<HTMLElement>('.work-card');
  const noResults  = document.getElementById('no-results');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const filter = btn.dataset.filter ?? 'all';
      let visible = 0;
      cards.forEach(card => {
        const match = filter === 'all' || card.dataset.category === filter;
        card.style.display = match ? '' : 'none';
        if (match) visible++;
      });
      if (noResults) {
        noResults.textContent = visible === 0 ? 'No projects in this category yet.' : '';
      }
    });
  });

  // ─── Gallery Hover Slideshow ─────────────────────────────────────────────────
  document.querySelectorAll<HTMLElement>('[data-gallery]').forEach(gallery => {
    const imgs = gallery.querySelectorAll<HTMLImageElement>('img');
    const dots = gallery.querySelectorAll<HTMLElement>('.dot');
    let current = 0;
    let interval: ReturnType<typeof setInterval>;

    function goTo(index: number) {
      imgs[current].classList.remove('active');
      dots[current]?.classList.remove('active');
      current = index;
      imgs[current].classList.add('active');
      dots[current]?.classList.add('active');
    }

    gallery.closest('.work-card')?.addEventListener('mouseenter', () => {
      interval = setInterval(() => goTo((current + 1) % imgs.length), 1000);
    });
    gallery.closest('.work-card')?.addEventListener('mouseleave', () => {
      clearInterval(interval);
      goTo(0);
    });
  });

  // ─── Lightbox Setup ──────────────────────────────────────────────────────────
  const lightbox   = document.getElementById('lightbox')!;
  const backdrop   = lightbox.querySelector('.lightbox-backdrop')!;
  const closeBtn   = lightbox.querySelector('.lightbox-close')!;
  const imgWrap    = document.getElementById('lightbox-img-wrap')!;
  const prevBtn    = document.getElementById('lb-prev')!;
  const nextBtn    = document.getElementById('lb-next')!;
  const counter    = document.getElementById('lightbox-counter')!;
  const lbCategory = document.getElementById('lb-category')!;
  const lbClient   = document.getElementById('lb-client')!;
  const lbDesc     = document.getElementById('lb-description')!;
  const lbTags     = document.getElementById('lb-tags')!;
  const lbYear     = document.getElementById('lb-year')!;

  let lbImages: string[] = [];
  let lbCurrent = 0;

  function openLightbox(card: HTMLElement) {
    lbImages  = JSON.parse(card.dataset.images || '[]');
    lbCurrent = 0;
    lbClient.textContent   = card.dataset.client || '';
    lbDesc.textContent     = card.dataset.description || '';
    lbCategory.textContent = card.dataset.category || '';
    lbYear.textContent     = card.dataset.year || '';
    const tags: string[] = JSON.parse(card.dataset.tags || '[]');
    lbTags.innerHTML = tags.map(t => `<span class="work-tag">${t}</span>`).join('');
    renderLightboxImages();
    lightbox.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox.classList.remove('open');
    document.body.style.overflow = '';
  }

  // CHANGE: Rewrote to use createElement instead of innerHTML string.
  // innerHTML string approach set the active class before the DOM existed,
  // causing images to not show on first open. createElement lets us set
  // the class directly on the element before appending it.
  function renderLightboxImages() {
    if (lbImages.length === 0) {
      const card = document.querySelector<HTMLElement>(`[data-client="${lbClient.textContent}"]`);
      const gradient = card?.dataset.gradient || '#111';
      imgWrap.innerHTML = `<div class="lb-gradient" style="background:${gradient}"></div>`;
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      counter.textContent = '';
      return;
    }

    imgWrap.innerHTML = '';

    lbImages.forEach((src, i) => {
      const img = document.createElement('img');
      img.src = src;
      img.alt = `Project image ${i + 1}`;
      img.className = 'lb-img' + (i === lbCurrent ? ' active' : '');
      imgWrap.appendChild(img);
    });

    const hasMultiple = lbImages.length > 1;
    // CHANGE: 'flex' not '' — matches display:flex in global CSS for centred arrows
    prevBtn.style.display = hasMultiple ? 'flex' : 'none';
    nextBtn.style.display = hasMultiple ? 'flex' : 'none';
    counter.textContent = hasMultiple ? `${lbCurrent + 1} / ${lbImages.length}` : '';
  }

  // CHANGE: Added imgs.length guard + fixed negative modulo wrapping.
  // Old: (index + lbImages.length) % lbImages.length — fails on index = -1 in some engines.
  // New: double modulo pattern handles all negative values correctly.
  function lbGoTo(index: number) {
    const imgs = imgWrap.querySelectorAll<HTMLImageElement>('.lb-img');
    if (imgs.length === 0) return;
    imgs[lbCurrent]?.classList.remove('active');
    lbCurrent = ((index % lbImages.length) + lbImages.length) % lbImages.length;
    imgs[lbCurrent]?.classList.add('active');
    counter.textContent = `${lbCurrent + 1} / ${lbImages.length}`;
  }

  document.querySelectorAll<HTMLButtonElement>('.open-lightbox').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest<HTMLElement>('.work-card');
      if (card) openLightbox(card);
    });
  });

  closeBtn.addEventListener('click', closeLightbox);
  backdrop.addEventListener('click', closeLightbox);
  prevBtn.addEventListener('click', () => lbGoTo(lbCurrent - 1));
  nextBtn.addEventListener('click', () => lbGoTo(lbCurrent + 1));

  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('open')) return;
    if (e.key === 'Escape')     closeLightbox();
    if (e.key === 'ArrowRight') lbGoTo(lbCurrent + 1);
    if (e.key === 'ArrowLeft')  lbGoTo(lbCurrent - 1);
  });

  // CHANGE: Added swipe support — previously no mobile swipe handling existed.
  // Swipe left = next image, swipe right = previous image. 50px threshold
  // prevents accidental triggers on small taps.
  let touchStartX = 0;
  lightbox.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
  }, { passive: true });
  lightbox.addEventListener('touchend', (e) => {
    const diff = touchStartX - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 50) {
      lbGoTo(diff > 0 ? lbCurrent + 1 : lbCurrent - 1);
    }
  });
</script>

<!-- CHANGE: <style> block completely removed.
     All styles moved to global.css to fix Astro scoping issue where
     dynamically created elements (via document.createElement) never
     receive Astro's data-attribute and therefore can't be targeted
     by scoped component styles. Global CSS has no such restriction. -->